---
apiVersion: apps/v1
kind: Deployment
metadata:
  {{ if eq .KUBE_NAMESPACE .BRANCH_ENV }}
  name: dashboard-{{ .DRONE_SOURCE_BRANCH }}
  {{ else }}
  name: dashboard
  {{ end }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{ if eq .KUBE_NAMESPACE .BRANCH_ENV }}
      name: dashboard-{{ .DRONE_SOURCE_BRANCH }}
      {{ else }}
      name: dashboard
      {{ end }}
  template:
    metadata:
      labels:
        {{ if eq .KUBE_NAMESPACE .BRANCH_ENV }}
        name: dashboard-{{ .DRONE_SOURCE_BRANCH }}
        service: dashboard-{{ .DRONE_SOURCE_BRANCH }}
        {{ else }}
        name: dashboard
        service: dashboard
        {{ end }}
    spec:
      containers:
        - name: dashboard
          image: quay.io/ukhomeofficedigital/digmygrafana:d5996c1c3bc9c333def581c20291632ee729c2c0
          imagePullPolicy: Always
          resources:
            requests:
              memory: 10Mi
              cpu: 10m
            limits:
              memory: 256Mi
              cpu: 300m
          env:
            - name: GF_SERVER_ROOT_URL
              {{ if eq .KUBE_NAMESPACE .PROD_ENV }}
              value: https://dashboard.modernslavery.homeoffice.gov.uk
              {{ else if eq .KUBE_NAMESPACE .STG_ENV }}
              value: https://dashboard.ms-notprod.homeoffice.gov.uk
              {{ else if eq .KUBE_NAMESPACE .UAT_ENV }}
              value: https://uat-dashboard.ms-notprod.homeoffice.gov.uk
              {{ else if eq .KUBE_NAMESPACE .BRANCH_ENV }}
              value: https://dashboard-{{ .DRONE_SOURCE_BRANCH }}.{{ .BRANCH_ENV }}.homeoffice.gov.uk
              {{ end }}
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: audit-database
                  key: endpoint
            - name: POSTGRES_USER
              value: grafana
            - name: POSTGRES_PASS
              valueFrom:
                secretKeyRef:
                  name: users
                  key: grafana
            - name: POSTGRES_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: audit-database
                  key: default_db
            - name: ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: grafana-admin
                  key: user
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-admin
                  key: password
            - name: SYSDIG_TOKEN
              valueFrom:
                secretKeyRef:
                  name: sysdig
                  key: token
            - name: SYSDIG_URL
              value: https://sysdig.digital.homeoffice.gov.uk
            - name: OAUTH_AUTO_LOGIN
              value: "true"
            - name: OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: oauth-client
                  key: id
            - name: OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: oauth-client
                  key: secret
            - name: OAUTH_SCOPE
              value: email
            - name: OAUTH_AUTH_URL
              value: https://sso-dev.notprod.homeoffice.gov.uk/auth/realms/ms-keycloak/protocol/openid-connect/auth
            - name: OAUTH_TOKEN_URL
              value: https://sso-dev.notprod.homeoffice.gov.uk/auth/realms/ms-keycloak/protocol/openid-connect/token
            - name: OAUTH_API_URL
              value: https://sso-dev.notprod.homeoffice.gov.uk/auth/realms/ms-keycloak/protocol/openid-connect/userinfo
            - name: SIGNOUT_REDIRECT_URL
              value: https://sso-dev.notprod.homeoffice.gov.uk/auth/realms/ms-keycloak/protocol/openid-connect/logout
            - name: JSON_DASHBOARDS
              value: {{.DASHBOARD_SETTINGS}}
          securityContext:
            runAsNonRoot: true

        - name: nginx-proxy
          # nginx-proxy-govuk:v4.1.4
          image: quay.io/ukhomeofficedigital/nginx-proxy-govuk@sha256:99a8b58a3c0f6a1d96ba04a1d8214459ddadcc1bb636e72d5b4e270af8e0416a
          env:
            - name: PROXY_SERVICE_HOST
              value: 127.0.0.1
            - name: PROXY_SERVICE_PORT
              value: "3000"
            - name: ENABLE_UUID_PARAM
              value: "FALSE"
            - name: NAXSI_USE_DEFAULT_RULES
              value: "FALSE"
            - name: PORT_IN_HOST_HEADER
              value: "FALSE"
            - name: ERROR_REDIRECT_CODES
              value: "599"
          ports:
            - containerPort: 10443
          securityContext:
            runAsNonRoot: true
