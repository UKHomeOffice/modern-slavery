---
apiVersion: apps/v1
kind: Deployment
metadata:
  {{ if eq .KUBE_NAMESPACE .PROD_ENV }}
  name: dashboard
  {{ else if eq .KUBE_NAMESPACE .BRANCH_ENV }}
  annotations:
    downscaler/uptime: {{ .NON_PROD_AVAILABILITY }}
  name: dashboard-{{ .DRONE_SOURCE_BRANCH }}
  {{ else }}
  annotations:
    downscaler/uptime: {{ .NON_PROD_AVAILABILITY }}
  name: dashboard
  {{ end }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{ if eq .KUBE_NAMESPACE .BRANCH_ENV }}
      name: dashboard-{{ .DRONE_SOURCE_BRANCH }}
      {{ else }}
      name: dashboard
      {{ end }}
  template:
    metadata:
      labels:
        {{ if eq .KUBE_NAMESPACE .BRANCH_ENV }}
        name: dashboard-{{ .DRONE_SOURCE_BRANCH }}
        service: dashboard-{{ .DRONE_SOURCE_BRANCH }}
        {{ else }}
        name: dashboard
        service: dashboard
        {{ end }}
    spec:
      containers:
        - name: dashboard
          image: quay.io/ukhomeofficedigital/digmygrafana:d5996c1c3bc9c333def581c20291632ee729c2c0
          imagePullPolicy: Always
          resources:
            requests:
              memory: 10Mi
              cpu: 10m
            limits:
              memory: 256Mi
              cpu: 300m
          env:
            - name: TZ
              value: Europe/London
            - name: GF_SERVER_ROOT_URL
              {{ if eq .KUBE_NAMESPACE .PROD_ENV }}
              value: https://dashboard.modernslavery.homeoffice.gov.uk
              {{ else if eq .KUBE_NAMESPACE .STG_ENV }}
              value: https://dashboard.ms-notprod.homeoffice.gov.uk
              {{ else if eq .KUBE_NAMESPACE .UAT_ENV }}
              value: https://uat-dashboard.ms-notprod.homeoffice.gov.uk
              {{ else if eq .KUBE_NAMESPACE .BRANCH_ENV }}
              value: https://dashboard-{{ .DRONE_SOURCE_BRANCH }}.{{ .BRANCH_ENV }}.homeoffice.gov.uk
              {{ end }}
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: audit-database
                  key: endpoint
            - name: POSTGRES_USER
              value: grafana
            - name: POSTGRES_PASS
              valueFrom:
                secretKeyRef:
                  name: users
                  key: grafana
            - name: POSTGRES_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: audit-database
                  key: default_db
            - name: ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: grafana-admin
                  key: user
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-admin
                  key: password
            - name: SYSDIG_TOKEN
              valueFrom:
                secretKeyRef:
                  name: sysdig
                  key: token
            - name: SYSDIG_URL
              value: https://sysdig.digital.homeoffice.gov.uk
            - name: OAUTH_AUTO_LOGIN
              value: "true"
            - name: OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: oauth-client
                  key: id
            - name: OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: oauth-client
                  key: secret
            - name: OAUTH_SCOPE
              value: email
            - name: OAUTH_AUTH_URL
              {{ if or (eq .KUBE_NAMESPACE .BRANCH_ENV) (eq .KUBE_NAMESPACE .UAT_ENV) }}
              value: https://acp-sso.notprod.acp.homeoffice.gov.uk/realms/ms-notprod/protocol/openid-connect/auth
              {{ else }}
              value: https://acp-sso.prod.acp.homeoffice.gov.uk/realms/ms-prod/protocol/openid-connect/auth
              {{ end }}
            - name: OAUTH_TOKEN_URL
              {{ if or (eq .KUBE_NAMESPACE .BRANCH_ENV) (eq .KUBE_NAMESPACE .UAT_ENV) }}
              value: https://acp-sso-admin.notprod.acp.homeoffice.gov.uk/realms/ms-notprod/protocol/openid-connect/token
              {{ else }}
              value: https://acp-sso.prod.acp.homeoffice.gov.uk/realms/ms-prod/protocol/openid-connect/token
              {{ end }}
            - name: OAUTH_API_URL
              {{ if or (eq .KUBE_NAMESPACE .BRANCH_ENV) (eq .KUBE_NAMESPACE .UAT_ENV) }}
              value: https://acp-sso-admin.notprod.acp.homeoffice.gov.uk/realms/ms-notprod/protocol/openid-connect/userinfo
              {{ else }}
              value: https://acp-sso-admin.prod.acp.homeoffice.gov.uk/realms/ms-prod/protocol/openid-connect/userinfo
              {{ end }}
            - name: SIGNOUT_REDIRECT_URL
              {{ if or (eq .KUBE_NAMESPACE .BRANCH_ENV) (eq .KUBE_NAMESPACE .UAT_ENV) }}
              value: https://acp-sso-admin.notprod.acp.homeoffice.gov.uk/realms/ms-notprod/protocol/openid-connect/logout
              {{ else }}
              value: https://acp-sso-admin.prod.acp.homeoffice.gov.uk/realms/ms-prod/protocol/openid-connect/logout
              {{ end }}
            - name: JSON_DASHBOARDS
              value: >
                [{
                  "annotations": {
                    "list": [
                      {
                        "builtIn": 1,
                        "datasource": "-- Grafana --",
                        "enable": true,
                        "hide": true,
                        "iconColor": "rgba(0, 211, 255, 1)",
                        "name": "Annotations & Alerts",
                        "type": "dashboard"
                      }
                    ]
                  },
                  "editable": true,
                  "gnetId": null,
                  "graphTooltip": 0,
                  "links": [],
                  "panels": [
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": true,
                      "colors": [
                        "#73BF69",
                        "#73BF69",
                        "#73BF69"
                      ],
                      "datasource": "Postgres",
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 0,
                        "y": 0
                      },
                      "id": 13,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n  $__timeGroupAlias(created_at,$__interval),\n  count(id) AS \"id\"\nFROM reports\nWHERE\n  $__timeFilter(created_at)\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "reports",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "title": "Incomplete Forms (Save and Return)",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorPostfix": false,
                      "colorValue": true,
                      "colors": [
                        "#C4162A",
                        "#C4162A",
                        "#C4162A"
                      ],
                      "datasource": "Postgres",
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 12,
                        "y": 0
                      },
                      "id": 7,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n $__timeGroupAlias(created_at,$__interval),\n count(id) AS \"id\"\nFROM hof\nWHERE\n $__timeFilter(created_at) AND\n success = 'false'\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "hof",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            },
                            {
                              "datatype": "bool",
                              "name": "",
                              "params": [
                                "success",
                                "=",
                                "'false'"
                              ],
                              "type": "expression"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "title": "NRM Form ➡️ SQS Error ❌",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": true,
                      "colors": [
                        "#73BF69",
                        "#73BF69",
                        "#73BF69"
                      ],
                      "datasource": "Postgres",
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 0,
                        "y": 5
                      },
                      "id": 6,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n $__timeGroupAlias(created_at,$__interval),\n count(id) AS \"id\"\nFROM hof\nWHERE\n $__timeFilter(created_at) AND\n success = 'true'\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "hof",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            },
                            {
                              "datatype": "bool",
                              "name": "",
                              "params": [
                                "success",
                                "=",
                                "'true'"
                              ],
                              "type": "expression"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "title": "NRM Form ➡️ SQS ✅",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": true,
                      "colors": [
                        "#C4162A",
                        "#C4162A",
                        "#C4162A"
                      ],
                      "datasource": "Postgres",
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 12,
                        "y": 5
                      },
                      "id": 5,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n $__timeGroupAlias(created_at,$__interval),\n count(id) AS \"id\"\nFROM resolver\nWHERE\n $__timeFilter(created_at) AND\n success = 'false'\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "resolver",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            },
                            {
                              "datatype": "bool",
                              "name": "",
                              "params": [
                                "success",
                                "=",
                                "'false'"
                              ],
                              "type": "expression"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "title": "Resolver ➡️ iCasework Submission Failed ❌",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": true,
                      "colors": [
                        "#73BF69",
                        "#73BF69",
                        "#73BF69"
                      ],
                      "datasource": "Postgres",
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 4,
                        "w": 12,
                        "x": 0,
                        "y": 10
                      },
                      "id": 4,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n $__timeGroupAlias(created_at,$__interval),\n count(id) AS \"id\"\nFROM resolver\nWHERE\n $__timeFilter(created_at) AND\n success = 'true'\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "resolver",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            },
                            {
                              "datatype": "bool",
                              "name": "",
                              "params": [
                                "success",
                                "=",
                                "'true'"
                              ],
                              "type": "expression"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "title": "Resolver ➡️ iCasework Submission ✅",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Postgres",
                      "format": "none",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 4,
                        "w": 12,
                        "x": 12,
                        "y": 10
                      },
                      "id": 11,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n $__timeGroupAlias(created_at,$__interval),\n count(id) AS \"id\"\nFROM hof\nWHERE\n $__timeFilter(created_at) AND\n type = '662265' AND\n success = 'true'\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "hof",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            },
                            {
                              "datatype": "varchar",
                              "name": "",
                              "params": [
                                "type",
                                "=",
                                "'662265'"
                              ],
                              "type": "expression"
                            },
                            {
                              "datatype": "bool",
                              "name": "",
                              "params": [
                                "success",
                                "=",
                                "'true'"
                              ],
                              "type": "expression"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "timeFrom": null,
                      "timeShift": null,
                      "title": "DTN Submissions",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Postgres",
                      "format": "none",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 0,
                        "y": 14
                      },
                      "id": 9,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n $__timeGroupAlias(created_at,$__interval),\n count(id) AS \"id\"\nFROM hof\nWHERE\n $__timeFilter(created_at) AND\n type = '560734' AND\n success = 'true'\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "hof",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            },
                            {
                              "datatype": "varchar",
                              "name": "",
                              "params": [
                                "type",
                                "=",
                                "'560734'"
                              ],
                              "type": "expression"
                            },
                            {
                              "datatype": "bool",
                              "name": "",
                              "params": [
                                "success",
                                "=",
                                "'true'"
                              ],
                              "type": "expression"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "timeFrom": null,
                      "timeShift": null,
                      "title": "NRM Submissions",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Sysdig",
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 12,
                        "y": 14
                      },
                      "id": 0,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "pluginVersion": "6.4.4",
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "filter": "cloudProvider.id=\"ms-sqs\"",
                          "groupAggregation": "sum",
                          "isSingleDataPoint": true,
                          "isTabularFormat": false,
                          "refId": "0",
                          "segmentBy": [],
                          "sortDirection": "desc",
                          "target": "aws.sqs.NumberOfMessagesReceived",
                          "timeAggregation": "sum"
                        }
                      ],
                      "thresholds": "",
                      "timeFrom": null,
                      "timeShift": null,
                      "title": "Number of SQS Messages Recieved",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "avg"
                    },
                    {
                      "datasource": "Postgres",
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": true,
                      "colors": [
                        "#73BF69",
                        "#73BF69",
                        "#73BF69"
                      ],
                      "format": "short",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 12,
                        "x": 0,
                        "y": 19
                      },
                      "id": 10,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "options": {},
                      "postfix": "",
                      "postfixFontSize": "200%",
                      "prefix": "",
                      "prefixFontSize": "200%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false,
                        "ymax": null,
                        "ymin": null
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "format": "time_series",
                          "group": [
                            {
                              "params": [
                                "$__interval",
                                "none"
                              ],
                              "type": "time"
                            }
                          ],
                          "metricColumn": "none",
                          "rawQuery": false,
                          "rawSql": "SELECT\n  $__timeGroupAlias(created_at,$__interval),\n  count(id) AS \"id\"\nFROM duplicates\nWHERE\n  $__timeFilter(created_at)\nGROUP BY 1\nORDER BY 1",
                          "refId": "A",
                          "select": [
                            [
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "column"
                              },
                              {
                                "params": [
                                  "count"
                                ],
                                "type": "aggregate"
                              },
                              {
                                "params": [
                                  "id"
                                ],
                                "type": "alias"
                              }
                            ]
                          ],
                          "table": "duplicates",
                          "timeColumn": "created_at",
                          "timeColumnType": "timestamptz",
                          "where": [
                            {
                              "name": "$__timeFilter",
                              "params": [],
                              "type": "macro"
                            }
                          ]
                        }
                      ],
                      "thresholds": "",
                      "title": "Duplicates",
                      "type": "singlestat",
                      "valueFontSize": "200%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "total"
                    },
                    {
                      "aliasColors": {},
                      "bars": true,
                      "dashLength": 10,
                      "dashes": false,
                      "datasource": "Sysdig",
                      "fill": 7,
                      "fillGradient": 0,
                      "gridPos": {
                        "h": 5,
                        "w": 24,
                        "x": 0,
                        "y": 24
                      },
                      "id": 1,
                      "legend": {
                        "avg": false,
                        "current": false,
                        "max": false,
                        "min": false,
                        "show": false,
                        "total": false,
                        "values": false
                      },
                      "lines": false,
                      "linewidth": 1,
                      "nullPointMode": "null",
                      "options": {
                        "dataLinks": []
                      },
                      "percentage": false,
                      "pointradius": 2,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": true,
                      "steppedLine": false,
                      "targets": [
                        {
                          "filter": "cloudProvider.id=\"ms-sqs-dlq\"",
                          "groupAggregation": "max",
                          "isSingleDataPoint": false,
                          "isTabularFormat": false,
                          "pageLimit": 10,
                          "refId": "0",
                          "segmentBy": [],
                          "sortDirection": "desc",
                          "target": "aws.sqs.ApproximateNumberOfMessagesVisible",
                          "timeAggregation": "max"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeRegions": [],
                      "timeShift": null,
                      "title": "Number of message in Dead Letter Queue 😵",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "short",
                          "label": "Total cases in queue",
                          "logBase": 1,
                          "max": null,
                          "min": 0,
                          "show": true
                        },
                        {
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": false
                        }
                      ],
                      "yaxis": {
                        "align": false,
                        "alignLevel": null
                      }
                    }
                  ],
                  "refresh": false,
                  "schemaVersion": 20,
                  "style": "dark",
                  "tags": [
                    "Sysdig",
                    "Private dashboard"
                  ],
                  "templating": {
                    "list": []
                  },
                  "time": {
                    "from": "now-12h",
                    "to": "now"
                  },
                  "timepicker": {
                    "refresh_intervals": [
                      "5s",
                      "10s",
                      "30s",
                      "1m",
                      "5m",
                      "15m",
                      "30m",
                      "1h",
                      "2h",
                      "1d"
                    ]
                  },
                  "timezone": "browser",
                  "title": "Modern Slavery",
                  "uid": "Qtv4svxZk",
                  "version": 1
                }]
          securityContext:
            runAsNonRoot: true

        - name: nginx-proxy
          image: quay.io/ukhomeofficedigital/nginx-proxy:v.4.4.7@sha256:0c58dabb1df4b4ad4bf1c6ed4ee1e81e440384e0ea41399c568aeb79e627b8ac
          env:
            - name: PROXY_SERVICE_HOST
              value: 127.0.0.1
            - name: PROXY_SERVICE_PORT
              value: "3000"
            - name: ENABLE_UUID_PARAM
              value: "FALSE"
            - name: NAXSI_USE_DEFAULT_RULES
              value: "FALSE"
            - name: PORT_IN_HOST_HEADER
              value: "FALSE"
            - name: ERROR_REDIRECT_CODES
              value: "599"
          ports:
            - containerPort: 10443
          securityContext:
            runAsNonRoot: true
